# ワークアウトアプリ データ永続化システム

## 概要
このワークアウトアプリは、Apple Watch上でのトレーニングデータの記録・管理・同期を行う包括的なデータ永続化システムを実装しています。

## アーキテクチャ構成

### 1. Core Dataモデル

#### エンティティ構成
- **WorkoutSession**: ワークアウトセッション全体を管理
- **WorkoutSet**: 個別のセット（重量・回数）を管理
- **Exercise**: エクササイズの種類（ベンチプレス、スクワット等）を管理
- **UserPreferences**: ユーザー設定を管理

#### エンティティ詳細

##### WorkoutSession
```swift
- sessionID: UUID（主キー）
- startTime: Date（開始時刻）
- endTime: Date?（終了時刻）
- isCompleted: Bool（完了フラグ）
- totalCalories: Double?（総消費カロリー）
- notes: String?（メモ）
- syncStatus: String（同期ステータス："pending", "synced"）
- isSyncedToHealthKit: Bool（HealthKit同期フラグ）
- healthKitWorkoutID: String?（HealthKitワークアウトID）
- createdAt: Date（作成日時）
- updatedAt: Date（更新日時）
- lastSyncedAt: Date?（最終同期日時）
- workoutSets: [WorkoutSet]（リレーション）
```

##### WorkoutSet
```swift
- setID: UUID（主キー）
- weight: Double（重量）
- repetitions: Int16（回数）
- setNumber: Int16（セット番号）
- isCompleted: Bool（完了フラグ）
- createdAt: Date（作成日時）
- updatedAt: Date（更新日時）
- exercise: Exercise（リレーション）
- workoutSession: WorkoutSession（リレーション）
```

##### Exercise
```swift
- exerciseID: UUID（主キー）
- name: String（エクササイズ名）
- category: String?（カテゴリ）
- muscleGroups: String?（対象筋肉群）
- instructions: String?（実行方法）
- isCustom: Bool（カスタム種目フラグ）
- createdAt: Date（作成日時）
- updatedAt: Date（更新日時）
- workoutSets: [WorkoutSet]（リレーション）
```

##### UserPreferences
```swift
- userID: UUID（主キー）
- healthKitEnabled: Bool（HealthKit連携有効）
- autoSyncEnabled: Bool（自動同期有効）
- defaultRestTime: Int32（デフォルト休憩時間）
- preferredUnit: String（重量単位："kg", "lbs"）
- createdAt: Date（作成日時）
- updatedAt: Date（更新日時）
```

### 2. 主要コンポーネント

#### PersistenceController
Core Dataスタックを管理し、データベースアクセスの基盤を提供。

**主な機能:**
- Core Dataコンテナの初期化
- 非同期保存処理
- エラーハンドリングとログ出力
- プレビュー用データの生成

```swift
func saveContext() async throws {
    let context = container.viewContext
    if context.hasChanges {
        try await context.perform {
            try context.save()
            Self.logger.info("Async context saved successfully")
        }
    }
}
```

#### HealthKitManager
HealthKitとの連携を管理し、ワークアウトデータをiOS Health appに同期。

**主な機能:**
- HealthKit認証の管理
- ワークアウトセッションの保存
- 重量データのHKQuantitySampleとしての保存
- 認証ステータスの監視

```swift
func saveWorkout(session: WorkoutSession) async throws -> String {
    let workout = HKWorkout(
        activityType: .traditionalStrengthTraining,
        start: session.startTime ?? Date(),
        end: session.endTime ?? Date(),
        totalEnergyBurned: totalEnergyBurned
    )
    try await healthStore.save(workout)
    return workout.uuid.uuidString
}
```

#### SyncManager
WatchConnectivityを使用したApple Watch ↔ iPhone間のデータ同期を管理。

**主な機能:**
- 未同期セッションの検出と送信
- バックグラウンド定期同期
- デバイス接続状態の監視
- 同期ステータスの管理

```swift
func syncPendingData() async {
    let pendingSessions = try await fetchPendingSessions()
    for session in pendingSessions {
        try await syncSession(session)
    }
    try await syncToHealthKit()
}
```

#### DataRecoveryManager
データの整合性チェック、バックアップ・リストア機能を提供。

**主な機能:**
- 孤立したWorkoutSetの修復
- 欠損したExercise参照の修復
- 不整合な日付データの修正
- 重複データの除去
- フルバックアップ・リストア

```swift
func performDataIntegrityCheck() async throws {
    try await fixOrphanedWorkoutSets()
    try await fixMissingExerciseReferences()
    try await fixInconsistentDates()
    try await removeDuplicateData()
}
```

#### WorkoutApp
アプリケーション全体を統括するメインクラス。

**主な機能:**
- 各種マネージャーの初期化と連携
- アプリライフサイクルの管理
- ワークアウトセッションの作成・管理
- エラーハンドリング

## 3. データフロー

### 通常の記録フロー
1. **ユーザーがワークアウト開始** → WorkoutSessionを作成
2. **セットを記録** → WorkoutSetをWorkoutSessionに関連付けて保存
3. **ワークアウト完了** → セッションを完了状態に更新
4. **自動同期** → SyncManagerがHealthKitとiPhoneに同期

### 同期フロー
1. **Apple Watch** → Core Dataに保存
2. **SyncManager** → WatchConnectivityでiPhoneに送信
3. **HealthKitManager** → iOS Health appに同期
4. **同期ステータス更新** → "pending" → "synced"

### エラー復旧フロー
1. **起動時整合性チェック** → DataRecoveryManagerが自動実行
2. **データ修復** → 孤立データの修正、参照の復元
3. **バックアップ作成** → 定期的なデータバックアップ
4. **緊急時リストア** → バックアップからの完全復元

## 4. 技術的特徴

### Swift 6 Concurrency対応
- `@MainActor`による適切なアクター分離
- `nonisolated`キーワードの使用
- `async/await`パターンの採用
- 弱参照による循環参照の回避

### エラーハンドリング
- カスタムエラー型の定義（HealthKitError, DataRecoveryError）
- 詳細なログ出力によるデバッグ支援
- 非致命的エラーの適切な処理

### データ整合性
- UUID主キーによる一意性保証
- リレーションシップの整合性維持
- 自動修復機能による堅牢性

## 5. 使用例

### ワークアウトセッションの作成
```swift
let session = workoutApp.createWorkoutSession()
workoutApp.addWorkoutSet(
    to: session,
    exercise: benchPress,
    weight: 80.0,
    repetitions: 10
)
workoutApp.completeWorkoutSession(session)
```

### 手動同期の実行
```swift
workoutApp.performManualSync()
```

### データバックアップ
```swift
let backupURL = try await workoutApp.exportUserData()
```

### データリストア
```swift
try await workoutApp.importUserData(from: backupURL)
```

## 6. 今後の拡張可能性

- **追加メトリクス**: 心拍数、運動強度などの記録
- **ソーシャル機能**: ワークアウトデータの共有
- **AI分析**: トレーニング傾向の自動分析
- **クラウド同期**: iCloud経由での複数デバイス同期
- **ウェアラブル連携**: 他のフィットネスデバイスとの統合

このシステムにより、ユーザーはApple Watch上で直感的にワークアウトを記録し、自動的にiPhoneとHealthKitに同期される包括的なフィットネス管理環境を利用できます。